<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>MOB Derby 画像対応版 v6（フェールセーフ入り）</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<style>
  :root{
    --bg:#0e1014; --panel:#161b22; --ink:#f2f6ff; --muted:#9fb0c9;
    --acc:#12c2ff; --ok:#47d764; --bad:#ff5c7a; --warn:#ffcf4d;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans","Yu Gothic",sans-serif}
  #app{position:fixed; inset:0; display:flex; flex-direction:column}
  header{padding:10px 14px; background:linear-gradient(180deg,#0c0d11,#0a0b0e); border-bottom:1px solid #222834; display:flex; align-items:center; justify-content:space-between}
  header h1{font-size:16px;margin:0;letter-spacing:.5px}
  header .btn{font-size:12px;padding:6px 10px;border:1px solid #2b323d;border-radius:8px;background:#0f141a;color:var(--ink);cursor:pointer}
  main{flex:1; position:relative; overflow:hidden; min-height:60vh}
  .panel{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(920px,92vw); background:var(--panel); border:1px solid #222834; border-radius:14px; box-shadow:0 12px 36px rgba(0,0,0,.35)}
  .panel header{border-radius:14px 14px 0 0}
  .pbody{padding:14px}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .tag{display:inline-block; padding:2px 8px; border:1px solid #2b323d; border-radius:999px; font-size:12px; color:var(--muted)}
  .btnPrimary{background:var(--acc); color:#001018; border:0; border-radius:10px; padding:12px 18px; font-weight:700; letter-spacing:.5px; cursor:pointer}
  .btnGhost{background:#0f141a; color:var(--ink); border:1px solid #2b323d; border-radius:10px; padding:12px 18px; font-weight:700; cursor:pointer}
  .btnBlock{display:block; width:100%}
  .grid{display:grid; gap:10px}
  .grid.two{grid-template-columns:1fr 1fr}
  .oddsBox{font-size:12px}
  .oddsTable{width:100%; border-collapse:collapse; font-size:12px}
  .oddsTable th,.oddsTable td{border-bottom:1px solid #2b323d; padding:6px 4px; text-align:center}
  .note{font-size:12px; color:var(--muted)}
  .splashLayer{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:#000; z-index:50}
  .fadeIn{animation:fadeIn 3s forwards}
  @keyframes fadeIn{0%{opacity:0}100%{opacity:1}}

  /* レースエリア */
  #race{position:absolute; inset:0; display:none}
  #lanesWrap{position:absolute; left:0; right:0; bottom:0; top:140px; overflow:hidden}
  #billboard{position:absolute; left:50%; transform:translateX(-50%); top:12px; width:min(1000px,94vw); height:100px; background:url('op.png') center/contain no-repeat, linear-gradient(90deg,#333,#222); z-index:2; pointer-events:none}
  #lanes{position:absolute; inset:0; background:#172028}
  .lane{position:relative; height:calc((100% - 9px)/10); border-top:1px dashed rgba(255,255,255,.08);}
  .lane::before{content:""; position:absolute; inset:0; background:url('doro.png') center/cover no-repeat, linear-gradient(#2a2f36,#1b2129); opacity:.95}
  .runner{position:absolute; left:8px; top:50%; transform:translateY(-50%); width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:800; color:#000; box-shadow:0 6px 16px rgba(0,0,0,.35); overflow:hidden; background:#ddd}
  .runner img{width:100%; height:100%; object-fit:contain; image-rendering:auto}
  .flag{position:absolute; right:10px; top:120px; padding:6px 10px; border-radius:8px; background:#0f1319cc; border:1px solid #2b323d; color:var(--muted); font-size:12px; z-index:3}
  .count{position:absolute; left:50%; top:46%; transform:translate(-50%,-50%); font-size:84px; font-weight:900; text-shadow:0 10px 30px rgba(0,0,0,.55); opacity:1; z-index:5}
  .centerLogo{position:absolute; left:50%; top:46%; transform:translate(-50%,-50%); z-index:6; pointer-events:none}
  .centerLogo img{width:min(480px,70vw); height:auto; display:block}
  .resultList{font-size:18px; line-height:1.7}
  .pay{font-size:22px; font-weight:900; margin-top:12px}
  .good{color:var(--ok)} .bad{color:var(--bad)}
  .chip{display:inline-flex; align-items:center; gap:6px}
  .dot{width:18px; height:18px; border-radius:6px; display:inline-block; vertical-align:middle}
  input,select{background:#0f1319; color:var(--ink); border:1px solid #2b323d; border-radius:8px; padding:10px 12px; width:100%}
  label{font-size:12px; color:var(--muted)}
  .tabs{display:flex; gap:6px; margin-bottom:8px}
  .tab{flex:1; text-align:center; padding:10px; border:1px solid #2b323d; border-radius:10px; cursor:pointer; user-select:none; font-size:13px}
  .tab.active{background:#0f1319}
  .stickyFooter{position:absolute; left:0; right:0; bottom:0; padding:12px; background:linear-gradient(180deg,rgba(20,22,26,0),#14161a 35%); display:flex; gap:10px}
  .scroll{max-height:min(62vh,520px); overflow:auto; padding-right:6px}
  .betBg{background:url('intro2.png') center/cover no-repeat, radial-gradient(60% 60% at 50% 10%,#222 0%,#15181d 60%,#0f1216 100%)}
  .fallbackTitle{font-size:28px; font-weight:900; letter-spacing:.08em; text-align:center}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>MOB Derby 画像対応版 v6</h1>
    <button class="btn" id="btnReset">強制リセット</button>
  </header>
  <main id="stage"></main>
</div>

<!-- レース領域 -->
<div id="race" aria-hidden="true">
  <div id="billboard"></div>
  <div class="count" id="count"></div>
  <div id="lanesWrap">
    <div id="lanes"></div>
  </div>
  <div class="flag" id="flag">距離：0%</div>
</div>

<script>
/* ========= 画像割当（index.html と同じフォルダ） ========= */
const IMG = {
  title: "title.png",
  opBg: "op.png",
  introLogo: "intro.png",
  startLogo: "start.png",
  betBg: "intro2.png",
  course: "doro.png",
  runner: {
    1:"rai.png", 2:"ora.png", 3:"blue.png", 4:"gold.png", 5:"vr.png",
    6:"pink.png",7:"green.png",8:"black.png",9:"chi.png", 10:"redblue.png" // ←要注意: レッドブルーのファイル名
  }
};

/* ========= データ ========= */
const CAST = [
 {id:1,  name:"レインボー",   vmax:155, rec:"S",  men:"B", tec:"A", kick:"B", stab:"A", color:"#ffe066"},
 {id:2,  name:"オレンジ",     vmax:151, rec:"B",  men:"B", tec:"B", kick:"B", stab:"B", color:"#ffa94d"},
 {id:3,  name:"ブルー",       vmax:149, rec:"C",  men:"A", tec:"A", kick:"C", stab:"S", color:"#74c0fc"},
 {id:4,  name:"ゴールド",     vmax:180, rec:"C",  men:"E", tec:"S", kick:"S", stab:"D", color:"#ffd43b"},
 {id:5,  name:"VR",           vmax:160, rec:"A",  men:"A", tec:"A", kick:"A", stab:"A", color:"#94d82d"},
 {id:6,  name:"ピンク",       vmax:149, rec:"B",  men:"S", tec:"D", kick:"S", stab:"S+",color:"#f783ac"},
 {id:7,  name:"グリーン",     vmax:153, rec:"C",  men:"C", tec:"A", kick:"S+",stab:"B", color:"#69db7c"},
 {id:8,  name:"ブラック",     vmax:162, rec:"B",  men:"S", tec:"A", kick:"S", stab:"B", color:"#ced4da"},
 {id:9,  name:"中華店主",     vmax:153, rec:"C",  men:"B", tec:"S", kick:"S", stab:"A", color:"#ffd8a8"},
 {id:10, name:"レッドブルー", vmax:170, rec:"S",  men:"A", tec:"C", kick:"A", stab:"B", color:"#ff8787"},
];
const TALK = {
  great:["負ける気がしません","私がNo.1です","今日という日に感謝"],
  good:["素晴らしい目覚めです","期待しててください","良いレースを見せます"],
  normal:["ベストを尽くします","全力で挑みます","応援よろしくお願いします"],
  bad:["さあ始めましょう","ちょうどいいハンデだ","気持ちが大事だ"],
  worst:["今朝の牛乳か..？","神に祈る","こんな日もある"]
};
const RANK_VAL = {"S+":1.25,"S":1.18,"A":1.12,"B":1.06,"C":1.00,"D":0.94,"E":0.88};
const MOOD_KEYS = ["worst","bad","normal","good","great"];
const MOOD_VAL = {worst:0.90,bad:0.96,normal:1.00,good:1.05,great:1.12};
const VIG = 0.15;

let state = {};
const $ = s=>document.querySelector(s);
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* ========= グローバルエラーハンドラ（真っ暗対策） ========= */
window.addEventListener("error", e=>{
  showErrorPanel(e.message || "Unknown error");
});
window.addEventListener("unhandledrejection", e=>{
  showErrorPanel((e.reason && (e.reason.message||e.reason)) || "Unhandled rejection");
});
function showErrorPanel(msg){
  const panel = document.createElement("div");
  panel.className = "panel";
  panel.innerHTML = `
    <header><h1>エラー</h1></header>
    <div class="pbody">
      <div style="color:#ff9aa7; font-weight:700; margin-bottom:8px;">スクリプトエラーが発生しました。</div>
      <pre style="white-space:pre-wrap;background:#0d1117;border:1px solid #30363d;padding:10px;border-radius:8px;max-height:50vh;overflow:auto;">${String(msg)}</pre>
      <div class="note" style="margin-top:8px">画像ファイル名の大小文字・スペル、index.html と同じフォルダ配置をご確認ください。</div>
      <div class="grid two" style="margin-top:10px">
        <button class="btnPrimary" id="retryBtn">再読み込み</button>
        <button class="btnGhost" id="continueBtn">ゲームに戻る</button>
      </div>
    </div>`;
  $("#stage").innerHTML = "";
  $("#stage").appendChild(panel);
  $("#retryBtn").onclick = ()=>location.reload();
  $("#continueBtn").onclick = ()=>{ $("#stage").innerHTML=""; init().catch(err=>showErrorPanel(err)); };
}

/* ========= ユーティリティ ========= */
function el(tag, attrs={}, ...kids){
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==="class") n.className=v;
    else if(k==="style") Object.assign(n.style,v);
    else n.setAttribute(k,v);
  });
  kids.forEach(k=>{
    if(k==null) return;
    if(typeof k==="string") n.appendChild(document.createTextNode(k));
    else n.appendChild(k);
  });
  return n;
}
function chipHTML(c){ return `<span class="chip"><span class="dot" style="background:${c.color}"></span>${c.id}. ${c.name}</span>`; }
function pickLine(mood){ const arr=TALK[mood]; return arr[Math.floor(Math.random()*arr.length)]; }
function weightedPick(keys,weights){
  const sum = weights.reduce((a,b)=>a+b,0);
  let r=Math.random()*sum;
  for(let i=0;i<keys.length;i++){ if((r-=weights[i])<=0) return keys[i]; }
  return keys[keys.length-1];
}

/* ========= 起動（OP→タイトル3秒→Yes/No） ========= */
document.addEventListener("DOMContentLoaded", ()=>{
  init().catch(err=>showErrorPanel(err));
});
async function init(){
  // 安全に race を非表示
  $("#race").style.display="none";
  $("#race").setAttribute("aria-hidden","true");

  // スプラッシュ（背景画像が無くてもグラデで見える）
  $("#stage").innerHTML = "";
  const layer = el("div",{class:"splashLayer", id:"opLayer",
    style:{background:`url('${IMG.opBg}') center/cover no-repeat, radial-gradient(60% 60% at 50% 20%, #222 0%, #111 70%)`}},
    // タイトル画像（失敗してもテキスト見出しが出る）
    el("div",{style:{textAlign:"center"}},
      el("img",{src:IMG.title, alt:"title", class:"fadeIn",
                onerror:"this.style.display='none'; this.closest('div').querySelector('.fallbackTitle').style.display='block';",
                style:"width:min(600px,80vw); height:auto; display:block; margin:0 auto;"}),
      el("div",{class:"fallbackTitle", style:{display:"none", color:"#e6f0ff"}}, "MOB DERBY")
    )
  );
  $("#stage").appendChild(layer);

  // 3秒後に Yes/No（画像が無くても必ず出る）
  await sleep(3000);
  const menu = el("div",{style:{position:"absolute", left:"50%", top:"70%", transform:"translate(-50%,-50%)", display:"grid", gap:"10px", zIndex:60}},
    el("button",{class:"btnPrimary", id:"startYes", style:{width:"200px"}}, "はい"),
    el("button",{class:"btnGhost", id:"startNo", style:{width:"200px"}}, "いいえ")
  );
  $("#stage").appendChild(menu);

  $("#startYes").onclick = async ()=>{
    $("#opLayer").remove(); menu.remove();
    await showIntroLogoThenIntro();
  };
  $("#startNo").onclick = ()=>{
    $("#stage").innerHTML = `<div class="panel"><header><h1>終了</h1></header><div class="pbody">ご利用ありがとうございました。</div></div>`;
  };
}

/* ========= 選手紹介！ロゴ → 2秒 → 紹介 ========= */
async function showIntroLogoThenIntro(){
  const logo = el("div",{class:"centerLogo"},
    el("img",{src:IMG.introLogo, alt:"intro", onerror:"this.style.display='none'; this.parentElement.innerHTML='<div class=fallbackTitle>選手紹介！</div>';"}));
  $("#stage").appendChild(logo);
  await sleep(2000);
  logo.remove();
  await showIntro();
}

/* ========= 紹介 → オッズ/ベット ========= */
async function showIntro(){
  const wrap = el("div",{class:"panel", style:{width:"min(720px,92vw)"}},
    el("header",{}, el("h1",{}, "選手紹介")),
    el("div",{class:"pbody scroll", id:"introList"}));
  $("#stage").innerHTML=""; $("#stage").appendChild(wrap);
  const list = $("#introList");

  const skipBtn = el("button",{class:"btnPrimary btnBlock", id:"skipIntro"}, "▶ スキップしてベットへ");
  list.appendChild(skipBtn);
  skipBtn.onclick = ()=> proceedToOddsAndBet();

  const head = el("div",{style:{textAlign:"center",margin:"10px 0 6px 0"}}, el("span",{class:"tag"},"2秒間 操作不可"));
  list.appendChild(head);

  // 調子決定（調子安定で分布バイアス）
  state.roster = CAST.map(c=>{
    let weights=[1,2,5,2,1];
    const sVal=RANK_VAL[c.stab]||1, boost=sVal-1;
    weights = weights.map((w,i)=> (w + (i===2?2.5:(i===3?2:(i===4?1.5:0)))*boost));
    const mood = weightedPick(MOOD_KEYS, weights);
    return {...c, mood, line: pickLine(mood)};
  });

  for(const r of state.roster){
    if(state.skipped) break;
    const card = el("div",{style:{padding:"12px", border:"1px solid #2b323d", borderRadius:"12px", marginBottom:"10px", background:"#0f1319", transform:"translateX(100%)", transition:"transform .35s ease"}},
      el("div",{style:{display:"flex",alignItems:"center",gap:"12px"}},
        el("div",{class:"chip"},
          el("span",{class:"dot", style:{background:r.color}}),
          document.createTextNode(` ${r.id}. ${r.name}`)
        ),
        el("div",{}, el("div",{style:{fontSize:"18px",fontWeight:800}}, r.name),
                     el("div",{class:"note"},"※ 調子は画面に表示されません（セリフで推測）"))
      ),
      el("div",{style:{fontSize:"18px",marginTop:"8px"}}, r.line)
    );
    list.appendChild(card);
    requestAnimationFrame(()=>{ card.style.transform="translateX(0)"; });
    await sleep(2000);
  }
  await proceedToOddsAndBet();
}

/* ========= オッズ計算（Plackett–Luce） ========= */
function computeFairProbs(roster){
  const strengths = {};
  roster.forEach(r=>{
    const s = r.vmax * (RANK_VAL[r.men]||1)**0.35 * (RANK_VAL[r.tec]||1)**0.35 * (RANK_VAL[r.kick]||1)**0.25 * ((r.mood&&MOOD_VAL[r.mood])||1);
    strengths[r.id]=s;
  });
  const ids = roster.map(r=>r.id);
  const sumS = ids.reduce((a,id)=>a+strengths[id],0);
  const pWin = {}; ids.forEach(id=> pWin[id] = strengths[id]/sumS );
  const pEx = {}; const pTri = {};
  ids.forEach(i=>{
    ids.forEach(j=>{
      if(i===j) return;
      const p1=strengths[i]/sumS, p2=strengths[j]/(sumS-strengths[i]);
      pEx[`${i}-${j}`]=p1*p2;
      ids.forEach(k=>{
        if(k===i||k===j) return;
        const p3=strengths[k]/(sumS-strengths[i]-strengths[j]);
        pTri[`${i}-${j}-${k}`]=p1*p2*p3;
      });
    });
  });
  return {pWin,pEx,pTri};
}
function applyHouse(){ const cap=(x,min,max)=>Math.max(min,Math.min(max,x)); return p=> p<=0?99.99:cap((1/p)*(1-VIG),1.01,99.99); }

/* ========= ベット画面 ========= */
async function proceedToOddsAndBet(){
  state.skipped=true;
  $("#stage").innerHTML = `<div class="panel betBg"><header><h1>オッズ計算中…</h1></header><div class="pbody">少々お待ちください</div></div>`;
  const fair = computeFairProbs(state.roster); const toDec = applyHouse();
  state.odds = {
    win: Object.fromEntries(Object.entries(fair.pWin).map(([id,p])=>[id, toDec(p)])),
    ex:  Object.fromEntries(Object.entries(fair.pEx).map(([k,p])=>[k, toDec(p)])),
    tri: Object.fromEntries(Object.entries(fair.pTri).map(([k,p])=>[k, toDec(p)])),
  };
  showBetUI();
}
function showBetUI(){
  $("#stage").innerHTML = `<div class="panel betBg">
    <header><h1>オッズ</h1></header>
    <div class="pbody scroll oddsBox">
      ${renderWinOddsSmall(state.odds)}
      <hr style="border:0;border-top:1px solid #2b323d;opacity:.6;margin:10px 0">
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="win">単勝</div>
        <div class="tab" data-tab="ex">2連（1→2）</div>
        <div class="tab" data-tab="tri">3連（1→2→3）</div>
      </div>
      <div id="betWrap"></div>
      <div class="note" style="margin-top:8px">※各種ベットは最大1000コイン。組み合わせオッズは非表示（内部計算のみ）。</div>
    </div>
    <div class="stickyFooter">
      <button class="btnGhost btnBlock" id="btnClear">ベットをクリア</button>
      <button class="btnPrimary btnBlock" id="btnReady" disabled>レース開始</button>
    </div>
  </div>`;
  state.bets = {win:null, ex:null, tri:null};
  renderBetForm("win");
  $("#tabs").addEventListener("click", e=>{
    const t=e.target.closest(".tab"); if(!t) return;
    $("#tabs .active")?.classList.remove("active"); t.classList.add("active");
    renderBetForm(t.dataset.tab);
  });
  $("#btnClear").onclick = ()=>{ state.bets={win:null,ex:null,tri:null}; renderBetForm($("#tabs .active").dataset.tab); updateReady(); };
  $("#btnReady").onclick = prepStart;
  updateReady();
}
function renderWinOddsSmall(od){
  const rows = CAST.map(c=>`<tr><td style="text-align:left">${chipHTML(c)}</td><td>${od.win[c.id].toFixed(2)}</td></tr>`).join("");
  return `<table class="oddsTable"><thead><tr><th style="text-align:left">単勝</th><th>オッズ</th></tr></thead><tbody>${rows}</tbody></table>`;
}
function renderBetForm(kind){
  const wrap = $("#betWrap"); wrap.innerHTML="";
  let form;
  if(kind==="win"){
    form = el("div",{},
      el("label",{},"単勝：1体を選択"),
      selectChar("win_sel"),
      el("label",{},"ベット額（0〜1000）"),
      el("input",{type:"number", id:"win_amt", min:0, max:1000, value: state.bets.win?.amt??0}),
      el("div",{class:"note", id:"win_od"},"選択中のオッズ：—")
    );
  }else if(kind==="ex"){
    form = el("div",{},
      el("label",{},"2連：1位 → 2位（順番固定）"),
      el("div",{class:"row"}, selectChar("ex_a"), selectChar("ex_b")),
      el("label",{},"ベット額（0〜1000）"),
      el("input",{type:"number", id:"ex_amt", min:0, max:1000, value: state.bets.ex?.amt??0}),
      el("div",{class:"note"},"組み合わせオッズは非表示です")
    );
  }else{
    form = el("div",{},
      el("label",{},"3連：1位 → 2位 → 3位（順番固定）"),
      el("div",{class:"row"}, selectChar("tri_a"), selectChar("tri_b"), selectChar("tri_c")),
      el("label",{},"ベット額（0〜1000）"),
      el("input",{type:"number", id:"tri_amt", min:0, max:1000, value: state.bets.tri?.amt??0}),
      el("div",{class:"note"},"組み合わせオッズは非表示です")
    );
  }
  wrap.appendChild(form);
  if(state.bets.win){ setSel("win_sel", state.bets.win.sel); $("#win_amt").value=state.bets.win.amt; }
  if(state.bets.ex){ setSel("ex_a", state.bets.ex.a); setSel("ex_b", state.bets.ex.b); $("#ex_amt").value=state.bets.ex.amt; }
  if(state.bets.tri){ ["a","b","c"].forEach(k=>setSel("tri_"+k, state.bets.tri[k])); $("#tri_amt").value=state.bets.tri.amt; }

  if(kind==="win"){
    $("#win_sel").oninput = saveBetWin;
    $("#win_amt").oninput = saveBetWin;
    saveBetWin();
  }else if(kind==="ex"){
    $("#ex_a").oninput = saveBetEx;
    $("#ex_b").oninput = saveBetEx;
    $("#ex_amt").oninput = saveBetEx;
    saveBetEx();
  }else{
    ["tri_a","tri_b","tri_c"].forEach(id=>$("#"+id).oninput = saveBetTri);
    $("#tri_amt").oninput = saveBetTri;
    saveBetTri();
  }
}
function selectChar(id){
  const s = el("select",{id});
  s.appendChild(el("option",{value:""},"— 選択 —"));
  CAST.forEach(c=> s.appendChild(el("option",{value:c.id}, `${c.id}. ${c.name}`)) );
  return s;
}
function setSel(id,val){ if(val!=null) $("#"+id).value=String(val); }
function saveBetWin(){
  const sel = +$("#win_sel").value||null;
  let amt = +$("#win_amt").value||0;
  if(amt<0) amt=0; if(amt>1000) amt=1000;
  $("#win_amt").value=amt;
  state.bets.win = sel? {type:"win", sel, amt} : null;
  $("#win_od").textContent = sel? `選択中のオッズ：${state.odds.win[sel].toFixed(2)}` : "選択中のオッズ：—";
  updateReady();
}
function saveBetEx(){
  const a = +$("#ex_a").value||null;
  const b = +$("#ex_b").value||null;
  let amt = +$("#ex_amt").value||0;
  if(amt<0) amt=0; if(amt>1000) amt=1000;
  $("#ex_amt").value=amt;
  if(a && b && a!==b){ state.bets.ex = {type:"ex", a,b, amt}; } else state.bets.ex=null;
  updateReady();
}
function saveBetTri(){
  const a = +$("#tri_a").value||null;
  const b = +$("#tri_b").value||null;
  const c = +$("#tri_c").value||null;
  let amt = +$("#tri_amt").value||0;
  if(amt<0) amt=0; if(amt>1000) amt=1000;
  $("#tri_amt").value=amt;
  if(a && b && c && a!==b && a!==c && b!==c){ state.bets.tri = {type:"tri", a,b,c, amt}; } else state.bets.tri=null;
  updateReady();
}
function updateReady(){
  const has = state.bets.win || state.bets.ex || state.bets.tri;
  $("#btnReady")?.toggleAttribute("disabled", !has);
}

/* ========= スタート前ロゴ → カウントダウン ========= */
async function prepStart(){
  state.betsFinal = JSON.parse(JSON.stringify(state.bets));
  $("#stage").innerHTML = "";
  $("#race").style.display="block";
  $("#race").setAttribute("aria-hidden","false");
  $("#lanes").innerHTML="";
  $("#flag").textContent="距離：0%";
  CAST.forEach(c=>{
    const lane = el("div",{class:"lane"});
    const run  = el("div",{class:"runner", id:"r"+c.id});
    const img = el("img",{src:IMG.runner[c.id], alt:c.name, onerror:"this.style.display='none'"}); // 画像が無くても動く
    run.appendChild(img);
    lane.appendChild(run);
    $("#lanes").appendChild(lane);
  });
  const logo = el("div",{class:"centerLogo"}, el("img",{src:IMG.startLogo, alt:"start", onerror:"this.style.display='none'; this.parentElement.innerHTML='<div class=fallbackTitle>まもなくレース開始！</div>';"}));
  $("#race").appendChild(logo);
  await sleep(2000);
  logo.remove();
  await startCountdown();
}
async function startCountdown(){
  const cnt = $("#count");
  for(const v of ["3","2","1","GO"]){
    cnt.textContent=v; cnt.style.opacity=1; await sleep(1000); cnt.style.opacity=0.2; await sleep(100);
  }
  cnt.textContent="";
  await runRace();
}

/* ========= レース本体（18〜28秒） ========= */
async function runRace(){
  const lanesW = $("#lanes").clientWidth;
  const goalPx = lanesW - 80;
  const TRACK = 1000;
  const duration = 18000 + Math.random()*10000; // 18〜28s
  const avgTargetSpeed = TRACK / (duration/1000);

  const P = {};
  let sumBase=0;
  (state.roster||CAST).forEach(r=>{
    const mood = (MOOD_VAL[r.mood] || 1);
    const base = 40 * Math.pow(r.vmax/155, 0.5) * Math.pow(RANK_VAL[r.men]||1,0.25) * Math.pow(RANK_VAL[r.tec]||1,0.25) * mood;
    P[r.id]={x:0, v:base, vmax:base*1.4, men:RANK_VAL[r.men]||1, tec:RANK_VAL[r.tec]||1, kick:RANK_VAL[r.kick]||1, stab:RANK_VAL[r.stab]||1};
    sumBase += base;
  });
  const avgBase = sumBase / CAST.length;
  const globalScale = avgTargetSpeed / avgBase;

  let mid=false;
  const t0=performance.now();
  return new Promise(resolve=>{
    function step(t){
      const dt = Math.min(40, t-(step._last||t0)); step._last=t;
      const elapsed = t - t0;
      const prog = Math.min(1, elapsed/duration);
      const anyMid = Object.values(P).some(p=>p.x>=TRACK*0.5); if(anyMid&&!mid) mid=true;

      Object.keys(P).forEach(id=>{
        const p=P[id];
        const jitter = (0.98 + 0.04*Math.random()) * (1 - (p.tec-1)*0.10) * (1 - (p.men-1)*0.08);
        const kick = 1 + (p.kick-1) * Math.pow(Math.max(0, prog-0.55)/0.45, 1.1);
        const global = (mid?1.05:1.0) * globalScale;
        const trouble = (Math.random()<0.015) ? (0.86 + 0.14*Math.random()) * (1 - (p.stab-1)*0.25) : 1.0;
        const vTarget = p.v * jitter * kick * global * trouble;
        p.v += (vTarget - p.v) * 0.04;
        p.v = Math.max(10, Math.min(p.v, p.vmax*globalScale*1.15));
        p.x += p.v * (dt/1000);
        if(p.x>TRACK) p.x=TRACK;
        const px = (p.x/TRACK) * goalPx;
        $("#r"+id).style.left = (8+px)+"px";
      });

      const leadX = Math.max(...Object.values(P).map(p=>p.x));
      $("#flag").textContent = `距離：${Math.round(leadX/TRACK*100)}%`;

      const done = Object.values(P).every(p=>p.x>=TRACK-0.1);
      if(done){ resolve(finish()); return; }
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  });

  function finish(){
    const order = Object.entries(P).map(([id,p])=>({id:+id, x:p.x + Math.random()*0.001})).sort((a,b)=>b.x-a.x).map(o=>o.id);
    state.finish = order;
    showResult();
  }
}

/* ========= 結果 & ペイアウト ========= */
function showResult(){
  const order=state.finish;
  const list = order.map((id,i)=>`<div>${i+1}位　${chipHTML(CAST.find(x=>x.id===id))}</div>`).join("");
  const {payout,hitText}=settleBets(order);
  $("#race").style.display="none";
  $("#race").setAttribute("aria-hidden","true");
  $("#stage").innerHTML = `<div class="panel">
    <header><h1>順位発表</h1></header>
    <div class="pbody">
      <div class="resultList">${list}</div>
      <div class="pay ${payout>0?'good':'bad'}">${hitText}</div>
      <div class="note" style="margin-top:6px">※ 2秒後に「次のレースに進みますか？」が表示されます。</div>
    </div>
  </div>`;
  setTimeout(askNext,2000);
}
function settleBets(order){
  let total=0; const b=state.betsFinal||{}; const msgs=[];
  if(b.win){
    const ok=(order[0]===b.win.sel);
    if(ok){ const odd=state.odds.win[b.win.sel]; const gain=Math.floor(b.win.amt*odd); total+=gain; msgs.push(`単勝 的中 +${gain}`); }
    else msgs.push("単勝 ハズレ");
  }
  if(b.ex){
    const ok=(order[0]===b.ex.a && order[1]===b.ex.b);
    if(ok){ const key=`${b.ex.a}-${b.ex.b}`; const odd=state.odds.ex[key]||0; const gain=Math.floor(b.ex.amt*odd); total+=gain; msgs.push(`2連 的中 +${gain}`); }
    else msgs.push("2連 ハズレ");
  }
  if(b.tri){
    const ok=(order[0]===b.tri.a && order[1]===b.tri.b && order[2]===b.tri.c);
    if(ok){ const key=`${b.tri.a}-${b.tri.b}-${b.tri.c}`; const odd=state.odds.tri[key]||0; const gain=Math.floor(b.tri.amt*odd); total+=gain; msgs.push(`3連 的中 +${gain}`); }
    else msgs.push("3連 ハズレ");
  }
  return {payout:total, hitText: total>0? `的中！ ${total} コイン手に入れた！` : `残念！ハズレ！　(${msgs.join(" / ")})`};
}
function askNext(){
  $("#stage").innerHTML = `<div class="panel betBg">
    <header><h1>次のレースに進みますか？</h1></header>
    <div class="pbody">
      <div class="grid two">
        <button class="btnPrimary" id="yes">はい</button>
        <button class="btnGhost" id="no">いいえ</button>
      </div>
      <div class="note" style="margin-top:10px">※「はい」で再び選手紹介からスタートします。</div>
    </div>
  </div>`;
  $("#yes").onclick = ()=>{ state.skipped=false; showIntroLogoThenIntro(); };
  $("#no").onclick = ()=>{ $("#stage").innerHTML = `<div class="panel"><header><h1>終了</h1></header><div class="pbody">ご利用ありがとうございました。</div></div>`; };
}

/* ========= 便利 ========= */
$("#btnReset").onclick = ()=>location.reload();
</script>
</body>
</html>
