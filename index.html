<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>MOB Derby v7.3（ペース配分＋ミニマップ）</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<style>
  :root{
    --bg:#0e1014; --panel:#161b22; --ink:#f2f6ff; --muted:#9fb0c9;
    --acc:#12c2ff; --ok:#47d764; --bad:#ff5c7a; --paper:#ffffff; --inkDark:#0b0f14; --inkMid:#334155; --line:#e5e7eb;
    --laneA:#8d939c; --laneB:#7f848d;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans","Yu Gothic",sans-serif}
  #app{position:fixed; inset:0; display:flex; flex-direction:column}
  header{padding:10px 14px; background:linear-gradient(180deg,#0c0d11,#0a0b0e); border-bottom:1px solid #222834; display:flex; align-items:center; justify-content:space-between}
  header h1{font-size:16px;margin:0;letter-spacing:.5px}
  header .btn{font-size:12px;padding:6px 10px;border:1px solid #2b323d;border-radius:8px;background:#0f141a;color:var(--ink);cursor:pointer}
  main{flex:1; position:relative; overflow:hidden; min-height:60vh}

  .panel{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(980px,95vw); background:var(--panel); border:1px solid #222834; border-radius:14px; box-shadow:0 12px 36px rgba(0,0,0,.35)}
  .panel header{border-radius:14px 14px 0 0}
  .pbody{padding:14px}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .btnPrimary{background:var(--acc); color:#001018; border:0; border-radius:12px; padding:14px 22px; font-weight:800; letter-spacing:.5px; cursor:pointer}
  .btnGhost{background:#0f141a; color:var(--ink); border:1px solid #2b323d; border-radius:12px; padding:12px 18px; font-weight:700; cursor:pointer}
  .btnBlock{display:block; width:100%}
  .grid{display:grid; gap:10px}
  .grid.two{grid-template-columns:1fr 1fr}
  .scroll{max-height:min(62vh,520px); overflow:auto; padding-right:6px}

  .paperWrap{background:transparent}
  .paper{background:var(--paper); color:var(--inkDark); border:1px solid var(--line); border-radius:14px; padding:14px}
  .paper h2{margin:6px 0 10px 0; font-size:18px}
  .paper input,.paper select{background:#fff; color:var(--inkDark); border:1px solid #cbd5e1; border-radius:8px; padding:10px 12px; width:100%}
  .paper table{width:100%; border-collapse:collapse; font-size:13px}
  .paper th,.paper td{border-bottom:1px solid #e5e7eb; padding:8px 6px; text-align:center}
  .paper th:first-child,.paper td:first-child{text-align:left}
  .oddsImg{width:28px; height:28px; border-radius:6px; object-fit:contain; vertical-align:middle; margin-right:8px; background:#f3f4f6}

  /* OPレイヤー */
  .splashLayer{
    position:absolute; inset:0; display:flex; flex-direction:column;
    align-items:center; justify-content:center; gap:18px;
    background:#000; z-index:50
  }
  .opTitle{display:block; width:min(600px,80vw); height:auto}
  .fadeIn{animation:fadeIn 2s forwards}
  @keyframes fadeIn{0%{opacity:0}100%{opacity:1}}

  /* 紹介スキップ */
  .skipBtn{
    position:fixed; right:12px; top:60px; z-index:60;
    background:#0f141a; color:#fff; border:1px solid #2b323d;
    border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.25);
  }

  /* レース */
  #race{position:absolute; inset:0; display:none}
  #billboard{
    position:absolute; left:50%; transform:translateX(-50%); top:12px;
    width:min(1000px,94vw); height:100px; padding:8px;
    background:linear-gradient(180deg,#1a2029,#141922);
    border:1px solid #222834; border-radius:10px; z-index:3; /* ミニマップはZ高め */
    display:flex; align-items:center; justify-content:center;
  }
  #miniCanvas{width:100%; height:84px; display:block}

  /* 横スクロール観戦 */
  #lanesWrap{
    position:absolute; left:0; right:0; bottom:0; top:140px;
    overflow-x:auto; overflow-y:hidden; background:#14161a;
    scrollbar-color:#2b323d transparent;
  }
  #lanes{ position:relative; height:100%; display:flex; flex-direction:column; }
  .lane{ position:relative; height:calc((100% - 9px)/10); border-top:1px solid rgba(255,255,255,.04); }
  .lane:nth-child(odd){ background:linear-gradient(180deg, var(--laneA) 0%, #878d96 100%); }
  .lane:nth-child(even){ background:linear-gradient(180deg, var(--laneB) 0%, #797f88 100%); }
  .lane::after{ content:""; position:absolute; inset:0; box-shadow:inset 0 6px 10px rgba(0,0,0,.18), inset 0 -6px 10px rgba(0,0,0,.18); pointer-events:none; }
  .laneLabel{ position:absolute; left:8px; top:50%; transform:translateY(-50%); background:rgba(20,22,26,.85); color:#e5e7eb; border:1px solid #2b323d; font-size:12px; padding:2px 6px; border-radius:6px; z-index:2; }
  .runner{position:absolute; left:48px; top:50%; transform:translateY(-50%); width:48px; height:48px; display:flex; align-items:center; justify-content:center; z-index:3}
  .runner img{ width:100%; height:100%; object-fit:contain; filter: drop-shadow(0 6px 10px rgba(0,0,0,.45)); }

  .finishLine{ position:absolute; top:0; bottom:0; width:6px; background:repeating-linear-gradient(180deg,#eee 0 12px,#111 12px 24px); box-shadow:0 0 0 1px #0008; }
  .finishTag{ position:absolute; top:6px; transform:translateX(-50%); background:#0f1319cc; border:1px solid #2b323d; color:#9fb0c9; font-size:12px; padding:4px 8px; border-radius:8px; }

  .flag{position:absolute; right:10px; top:120px; padding:6px 10px; border-radius:8px; background:#0f1319cc; border:1px solid #2b323d; color:#9fb0c9; font-size:12px; z-index:3}
  .count{position:absolute; left:50%; top:46%; transform:translate(-50%,-50%); font-size:84px; font-weight:900; text-shadow:0 10px 30px rgba(0,0,0,.55); opacity:1; z-index:5; color:#ffffffcc}
  .centerLogo{position:absolute; left:50%; top:46%; transform:translate(-50%,-50%); z-index:6; pointer-events:none}
  .centerLogo img{width:min(480px,70vw); height:auto; display:block}
  .resultList{font-size:18px; line-height:1.7}
  .pay{font-size:22px; font-weight:900; margin-top:12px}
  .good{color:var(--ok)} .bad{color:var(--bad)}
  .chip{display:inline-flex; align-items:center; gap:8px}
  .chipImg{width:36px;height:36px;border-radius:8px;object-fit:contain;background:#0d1117;border:1px solid #2b323d}
  .dot{width:18px; height:18px; border-radius:6px; display:inline-block; vertical-align:middle}
  .tabs{display:flex; gap:6px; margin-bottom:8px}
  .tab{flex:1; text-align:center; padding:10px; border:1px solid #d1d5db; border-radius:10px; cursor:pointer; user-select:none; font-size:13px; color:var(--inkDark); background:#fff}
  .tab.active{background:#f3f4f6}
  .stickyFooter{position:sticky; bottom:0; padding:12px; background:linear-gradient(180deg,rgba(20,22,26,0),#14161a 35%); display:flex; gap:10px}

  /* 観戦HUD */
  .specHUD{
    position:absolute; left:12px; bottom:12px; z-index:5;
    display:flex; gap:8px; align-items:center;
    background:#0f141acc; border:1px solid #2b323d; padding:8px 10px; border-radius:10px;
    font-size:12px; color:#cbd5e1;
  }
  .toggle{ appearance:none; width:38px; height:22px; border-radius:999px; background:#334155; position:relative; outline:none; cursor:pointer; border:1px solid #1f2937; }
  .toggle:checked{background:#22c55e}
  .toggle::after{ content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; border-radius:999px; background:#fff; transition:left .15s ease; }
  .toggle:checked::after{ left:18px; }

  /* JSが動かない時の予備UI */
  #bootFallback{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#e5e7eb}
  #bootFallback .box{background:#111; border:1px solid #2b323d; padding:20px; border-radius:12px; text-align:center}
  #bootFallback .box button{margin-top:10px}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>MOB Derby v7.3</h1>
    <button class="btn" id="btnReset">強制リセット</button>
  </header>
  <main id="stage">
    <div id="bootFallback">
      <div class="box">
        <div>読み込み中…（動かない場合は更新 or キャッシュ削除）</div>
        <button class="btnPrimary" onclick="location.reload()">ゲーム開始（再読み込み）</button>
      </div>
    </div>
  </main>
</div>

<!-- レース領域 -->
<div id="race" aria-hidden="true">
  <div id="billboard"><canvas id="miniCanvas" width="1000" height="84"></canvas></div>
  <div class="count" id="count"></div>
  <div id="lanesWrap"><div id="lanes"></div></div>
  <div class="flag" id="flag">距離：0%</div>
  <div class="specHUD" id="specHUD" style="display:none">
    <label style="display:flex; align-items:center; gap:6px">
      <input type="checkbox" id="followChk" class="toggle" checked>
      <span>自動追尾</span>
    </label>
    <button class="btnGhost" id="jumpStart">スタート付近</button>
    <button class="btnGhost" id="jumpFinish">ゴール付近</button>
  </div>
</div>

<script>
/* ========= 画像/データ ========= */
var IMG={title:"title.png",opBg:"op.png",introLogo:"intro.png",startLogo:"start.png",betBg:"intro2.png",runner:{1:"rai.png",2:"ora.png",3:"blue.png",4:"gold.png",5:"vr.png",6:"pink.png",7:"green.png",8:"black.png",9:"chi.png",10:"redblue.png"}};
var CAST=[{id:1,name:"レインボー",vmax:155,rec:"S",men:"B",tec:"A",kick:"B",stab:"A",color:"#ffe066"},{id:2,name:"オレンジ",vmax:151,rec:"B",men:"B",tec:"B",kick:"B",stab:"B",color:"#ffa94d"},{id:3,name:"ブルー",vmax:149,rec:"C",men:"A",tec:"A",kick:"C",stab:"S",color:"#74c0fc"},{id:4,name:"ゴールド",vmax:180,rec:"C",men:"E",tec:"S",kick:"S",stab:"D",color:"#ffd43b"},{id:5,name:"VR",vmax:160,rec:"A",men:"A",tec:"A",kick:"A",stab:"A",color:"#94d82d"},{id:6,name:"ピンク",vmax:149,rec:"B",men:"S",tec:"D",kick:"S",stab:"S+",color:"#f783ac"},{id:7,name:"グリーン",vmax:153,rec:"C",men:"C",tec:"A",kick:"S+",stab:"B",color:"#69db7c"},{id:8,name:"ブラック",vmax:162,rec:"B",men:"S",tec:"A",kick:"S",stab:"B",color:"#ced4da"},{id:9,name:"中華店主",vmax:153,rec:"C",men:"B",tec:"S",kick:"S",stab:"A",color:"#ffd8a8"},{id:10,name:"レッドブルー",vmax:170,rec:"S",men:"A",tec:"C",kick:"A",stab:"B",color:"#ff8787"}];
var TALK={great:["負ける気がしません","私がNo.1です","今日という日に感謝"],good:["素晴らしい目覚めです","期待しててください","良いレースを見せます"],normal:["ベストを尽くします","全力で挑みます","応援よろしくお願いします"],bad:["さあ始めましょう","ちょうどいいハンデだ","気持ちが大事だ"],worst:["今朝の牛乳か..？","神に祈る","こんな日もある"]};
var RANK_VAL={"S+":1.25,S:1.18,A:1.12,B:1.06,C:1.00,D:0.94,E:0.88};
var MOOD_KEYS=["worst","bad","normal","good","great"];
var MOOD_VAL={worst:0.90,bad:0.96,normal:1.00,good:1.05,great:1.12};
var VIG=0.15;

/* ========= 共通ユーティリティ ========= */
var state={};
var $=function(s){return document.querySelector(s);};
var sleep=function(ms){return new Promise(function(r){setTimeout(r,ms);});};
var PRELOADED={};
function preloadImage(src){return new Promise(function(res){if(!src){res(false);return}var im=new Image();im.decoding="async";im.onload=function(){PRELOADED[src]=im;res(true)};im.onerror=function(){res(false)};im.src=src})}
async function preloadAll(timeoutMs){timeoutMs=timeoutMs||2000;var list=Object.values(IMG.runner);var ps=list.map(preloadImage);var to=new Promise(function(r){setTimeout(function(){r("timeout")},timeoutMs)});try{await Promise.race([Promise.all(ps),to])}catch(_){}} 
function el(tag, attrs){var n=document.createElement(tag);attrs=attrs||{};Object.keys(attrs).forEach(function(k){var v=attrs[k];if(k==="class")n.className=v;else if(k==="style")n.style.cssText=typeof v==="string"?v:"";else if(k==="onerror")n.onerror=function(){try{eval(v)}catch(_){}};else n.setAttribute(k,v)});for(var i=2;i<arguments.length;i++){var c=arguments[i];if(c==null)continue;n.appendChild(typeof c==="string"?document.createTextNode(c):c)}return n}
function weightedPick(keys,weights){var sum=weights.reduce(function(a,b){return a+b},0);var r=Math.random()*sum;for(var i=0;i<keys.length;i++){r-=weights[i];if(r<=0)return keys[i]}return keys[keys.length-1]}
function pickLine(mood){var a=TALK[mood];return a[Math.floor(Math.random()*a.length)]}
function numericOnly(input){
  input.addEventListener("keydown", function(e){
    var k=e.key, ctrl=e.ctrlKey||e.metaKey;
    if(/^[0-9]$/.test(k)||["Backspace","Delete","ArrowLeft","ArrowRight","Tab","Home","End"].indexOf(k)>=0|| (ctrl&&["a","c","v","x"].indexOf(k.toLowerCase())>=0)) return;
    if(k==="Enter"){ e.preventDefault(); return; }
    if(["e","E","+","-",".",","," "].indexOf(k)>=0){ e.preventDefault(); }
  });
  input.addEventListener("input", function(){
    var v=input.value.replace(/[^\d]/g,""); var n=v===""?0:parseInt(v,10);
    if(isNaN(n)) n=0; if(n<0)n=0; if(n>1000)n=1000; input.value=String(n);
  });
}
function clamp(x,a,b){return Math.max(a,Math.min(b,x))}
function lerp(a,b,t){return a+(b-a)*t}
function easeOutCubic(t){t=clamp(t,0,1);return 1- Math.pow(1-t,3)}
function easeInOutQuad(t){t=clamp(t,0,1);return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2}

/* ========= 起動 ========= */
document.addEventListener("DOMContentLoaded", function(){ init().catch(showErrorPanel); });
function showErrorPanel(msg){
  var panel=el("div",{class:"panel"},
    el("header",{},el("h1",{},"エラー")),
    el("div",{class:"pbody"},
      el("div",{style:"color:#ff9aa7; font-weight:700; margin-bottom:8px"},"スクリプトエラーが発生しました。"),
      el("pre",{style:"white-space:pre-wrap;background:#0d1117;border:1px solid #30363d;padding:10px;border-radius:8px;max-height:50vh;overflow:auto;"}, String(msg)),
      el("div",{class:"grid two",style:"margin-top:10px"}, 
        el("button",{class:"btnPrimary",onclick:"location.reload()"},"再読み込み"),
        el("button",{class:"btnGhost",onclick:"document.querySelector('#stage').innerHTML=''; init().catch(()=>{})"},"ゲームに戻る")
      )
    )
  );
  $("#stage").innerHTML=""; $("#stage").appendChild(panel);
}
async function init(){
  $("#race").style.display="none"; $("#race").setAttribute("aria-hidden","true");
  $("#stage").innerHTML="";
  await preloadAll(2000);

  var layer=el("div",{class:"splashLayer",id:"opLayer",
    style:"background: url('"+IMG.opBg+"') center/cover no-repeat, radial-gradient(60% 60% at 50% 20%, #222 0%, #111 70%);"},
    el("img",{src:IMG.title,alt:"title",class:"opTitle fadeIn",onerror:"this.style.display='none'"}),
    el("button",{id:"startBtn",class:"btnPrimary",style:"font-size:20px; padding:16px 28px"},"ゲーム開始")
  );
  $("#stage").appendChild(layer);
  $("#startBtn").onclick = startFlow;
}
async function startFlow(){ var op=$("#opLayer"); if(op&&op.parentNode)op.parentNode.removeChild(op); await showIntroLogoThenIntro(); }

var introCancelled=false;
async function showIntroLogoThenIntro(){
  introCancelled=false;
  var logo=el("div",{class:"centerLogo",id:"introLogoBox"},
    el("img",{src:IMG.introLogo,alt:"intro",onerror:"this.style.display='none'; this.parentElement.innerHTML='<div style=color:#fff;font-size:32px;font-weight:900>選手紹介！</div>'"}));
  var skip=makeSkipButton();
  $("#stage").appendChild(logo); $("#stage").appendChild(skip);
  var until=Date.now()+2000; while(Date.now()<until && !introCancelled){ await sleep(50); }
  if(introCancelled){ safeRemove(skip); safeRemove(logo); return; }
  safeRemove(logo); await showIntro(skip);
}
function makeSkipButton(){
  var b=el("button",{class:"skipBtn",id:"skipIntroBtn"},"スキップ");
  b.onclick=function(){ introCancelled=true; safeRemove("#introLogoBox"); safeRemove("#skipIntroBtn"); proceedToOddsAndBet(); };
  return b;
}
function safeRemove(x){ var n=(typeof x==="string")?$(x):x; if(n&&n.parentNode) n.parentNode.removeChild(n); }

async function showIntro(skipBtn){
  state.roster = CAST.map(function(c){
    var w=[1,2,5,2,1]; var s=RANK_VAL[c.stab]||1, boost=s-1;
    w=w.map(function(v,i){return v+(i===2?2.5:(i===3?2:(i===4?1.5:0)))*boost});
    var mood = weightedPick(MOOD_KEYS,w);
    return Object.assign({},c,{mood:mood,line:pickLine(mood)});
  });
  var wrap=el("div",{class:"panel",style:"width:min(900px,95vw)"},
    el("header",{}, el("h1",{},"選手紹介")),
    el("div",{class:"pbody scroll",id:"introList"}));
  $("#stage").innerHTML=""; $("#stage").appendChild(wrap);
  if(skipBtn && !document.contains(skipBtn)) $("#stage").appendChild(skipBtn);

  var list=$("#introList");
  for(var i=0;i<state.roster.length;i++){
    if(introCancelled) break;
    var r=state.roster[i];
    var src=IMG.runner[r.id]||"", cached=PRELOADED[src];
    var im=el("img",{class:"chipImg",alt:r.name,style:"width:54px;height:54px"}); im.decoding="async"; im.onerror=function(){this.style.display="none"}; im.src=(cached&&cached.src)?cached.src:src;
    var card=el("div",{class:"paper",style:"margin-bottom:10px; display:flex; align-items:center; gap:14px"},
      im,
      el("div",{},
        (function(){ var c=el("div",{class:"chip"}); var d=el("span",{class:"dot",style:"background:"+r.color+"; width:18px; height:18px; border-radius:6px; display:inline-block; margin-right:8px"}); c.appendChild(d); c.appendChild(document.createTextNode(" "+r.id+". "+r.name)); return c; })(),
        el("div",{style:"font-size:18px; margin-top:6px; color:var(--inkMid)"}, r.line)
      )
    );
    list.appendChild(card);
    var until=Date.now()+2000; while(Date.now()<until && !introCancelled){ await sleep(50); }
  }
  if(!introCancelled){ if(skipBtn) safeRemove(skipBtn); await proceedToOddsAndBet(); }
}

/* ========= オッズ ========= */
function computeFairProbs(roster){
  var s={}; roster.forEach(function(r){
    var val=r.vmax*Math.pow(RANK_VAL[r.men]||1,.35)*Math.pow(RANK_VAL[r.tec]||1,.35)*Math.pow(RANK_VAL[r.kick]||1,.25)*((r.mood&&MOOD_VAL[r.mood])||1);
    s[r.id]=val;
  });
  var ids=roster.map(function(r){return r.id}); var sum=ids.reduce(function(a,id){return a+s[id]},0);
  var pWin={}; ids.forEach(function(id){ pWin[id]=s[id]/sum; });
  var pEx={}, pTri={};
  ids.forEach(function(i){
    ids.forEach(function(j){ if(i===j)return;
      var p1=s[i]/sum, p2=s[j]/(sum-s[i]); pEx[i+"-"+j]=p1*p2;
      ids.forEach(function(k){ if(k===i||k===j)return; var p3=s[k]/(sum-s[i]-s[j]); pTri[i+"-"+j+"-"+k]=p1*p2*p3; });
    });
  });
  return {pWin:pWin,pEx:pEx,pTri:pTri};
}
function applyHouse(){ var cap=function(x,a,b){return Math.max(a,Math.min(b,x))}; return function(p){ return p<=0?99.99:cap((1/p)*(1-VIG),1.01,99.99); }; }

async function proceedToOddsAndBet(){
  $("#stage").innerHTML='<div class="panel paperWrap"><header><h1>オッズ&ベット</h1></header><div class="pbody">計算中…</div></div>';
  var fair=computeFairProbs(state.roster||CAST), toDec=applyHouse();
  state.odds={win:Object.fromEntries(Object.keys(fair.pWin).map(function(id){return[id,toDec(fair.pWin[id])]})),
              ex:Object.fromEntries(Object.keys(fair.pEx).map(function(k){return[k,toDec(fair.pEx[k])]})),
              tri:Object.fromEntries(Object.keys(fair.pTri).map(function(k){return[k,toDec(fair.pTri[k])]}))};
  showBetUI();
}
function showBetUI(){
  var oddsTable = (function(od){
    var rows = CAST.map(function(c){
      var src=IMG.runner[c.id]||"", img='<img class="oddsImg" src="'+src+'" alt="'+c.name+'" onerror="this.style.display=\'none\'">';
      return '<tr><td style="text-align:left">'+img+c.id+'. '+c.name+'</td><td>'+od.win[c.id].toFixed(2)+'</td></tr>';
    }).join("");
    return '<table><thead><tr><th style="text-align:left">キャラクター</th><th>単勝</th></tr></thead><tbody>'+rows+'</tbody></table>';
  })(state.odds);

  $("#stage").innerHTML =
    '<div class="panel paperWrap" style="width:min(980px,95vw)">'+
      '<header><h1 style="margin:10px 14px">オッズ&ベット</h1></header>'+
      '<div class="pbody scroll" style="display:grid; gap:12px">'+
        '<div class="paper"><h2>単勝オッズ（参考）</h2>'+oddsTable+'</div>'+
        '<div class="paper"><h2>ベット</h2>'+
          '<div class="tabs" id="tabs">'+
            '<div class="tab active" data-tab="win">単勝</div>'+
            '<div class="tab" data-tab="ex">2連（1→2）</div>'+
            '<div class="tab" data-tab="tri">3連（1→2→3）</div>'+
          '</div>'+
          '<div id="betWrap"></div>'+
          '<div style="font-size:12px; color:#6b7280; margin-top:6px">各種ベットは最大1000コインまで。</div>'+
        '</div>'+
        '<div class="stickyFooter" style="gap:10px">'+
          '<button class="btnGhost btnBlock" id="btnClear">ベットをクリア</button>'+
          '<button class="btnPrimary btnBlock" id="btnReady" disabled>レース開始</button>'+
        '</div>'+
      '</div>'+
    '</div>';

  state.bets={win:null,ex:null,tri:null};
  renderBetForm("win");
  $("#tabs").addEventListener("click", function(e){
    var t=e.target.closest(".tab"); if(!t) return;
    var a=$("#tabs .active"); if(a) a.classList.remove("active"); t.classList.add("active");
    renderBetForm(t.getAttribute("data-tab"));
  });
  $("#btnClear").onclick=function(){state.bets={win:null,ex:null,tri:null}; renderBetForm($("#tabs .active").getAttribute("data-tab")); updateReady();};
  $("#btnReady").onclick=prepStart;
  updateReady();
}
function renderBetForm(kind){
  var wrap=$("#betWrap"); wrap.innerHTML="";
  function selectChar(id){ var s=el("select",{id:id}); s.appendChild(el("option",{value:""},"— 選択 —")); CAST.forEach(function(c){ s.appendChild(el("option",{value:c.id}, c.id+". "+c.name)); }); return s; }
  function sanitizeAmt(n){ n = (isFinite(n)?n:0)|0; if(n<0)n=0; if(n>1000)n=1000; return n; }
  function numeric(id){ var n=$("#"+id); if(n) numericOnly(n); }

  var f;
  if(kind==="win"){
    f = el("div",{}, el("label",{},"単勝：1体を選択"), selectChar("win_sel"),
      el("label",{},"ベット額（0〜1000）"), el("input",{type:"number",inputmode:"numeric",pattern:"[0-9]*",step:"1",id:"win_amt",min:0,max:1000,value:state.bets.win?state.bets.win.amt:0}),
      el("div",{style:"font-size:12px; color:#6b7280",id:"win_od"},"選択中のオッズ：—"));
  }else if(kind==="ex"){
    f = el("div",{}, el("label",{},"2連：1位 → 2位（順序固定）"),
      el("div",{class:"row"}, selectChar("ex_a"), selectChar("ex_b")),
      el("label",{},"ベット額（0〜1000）"), el("input",{type:"number",inputmode:"numeric",pattern:"[0-9]*",step:"1",id:"ex_amt",min:0,max:1000,value:state.bets.ex?state.bets.ex.amt:0}),
      el("div",{style:"font-size:12px; color:#6b7280"},"組み合わせオッズは非表示です"));
  }else{
    f = el("div",{}, el("label",{},"3連：1位 → 2位 → 3位（順序固定）"),
      el("div",{class:"row"}, selectChar("tri_a"), selectChar("tri_b"), selectChar("tri_c")),
      el("label",{},"ベット額（0〜1000）"), el("input",{type:"number",inputmode:"numeric",pattern:"[0-9]*",step:"1",id:"tri_amt",min:0,max:1000,value:state.bets.tri?state.bets.tri.amt:0}),
      el("div",{style:"font-size:12px; color:#6b7280"},"組み合わせオッズは非表示です"));
  }
  wrap.appendChild(f);

  numeric("win_amt"); numeric("ex_amt"); numeric("tri_amt");
  function setSel(id,val){ if(val!=null) $("#"+id).value=String(val); }
  if(state.bets.win){ setSel("win_sel", state.bets.win.sel); $("#win_amt").value=state.bets.win.amt; }
  if(state.bets.ex){ setSel("ex_a", state.bets.ex.a); setSel("ex_b", state.bets.ex.b); $("#ex_amt").value=state.bets.ex.amt; }
  if(state.bets.tri){ ["a","b","c"].forEach(function(k){ setSel("tri_"+k, state.bets.tri[k]); }); $("#tri_amt").value=state.bets.tri.amt; }

  function saveWin(){ var sel=+($("#win_sel").value||0)||null; var amt=sanitizeAmt(parseInt($("#win_amt").value,10)); $("#win_amt").value=amt; state.bets.win=(sel&&amt>0)?{type:"win",sel:sel,amt:amt}:(sel?{type:"win",sel:sel,amt:0}:null); $("#win_od").textContent=sel?("選択中のオッズ："+state.odds.win[sel].toFixed(2)):"選択中のオッズ：—"; updateReady(); }
  function saveEx(){ var a=+($("#ex_a").value||0)||null; var b=+($("#ex_b").value||0)||null; var amt=sanitizeAmt(parseInt($("#ex_amt").value,10)); $("#ex_amt").value=amt; state.bets.ex=(a&&b&&a!==b)?{type:"ex",a:a,b:b,amt:amt}:null; updateReady(); }
  function saveTri(){ var a=+($("#tri_a").value||0)||null; var b=+($("#tri_b").value||0)||null; var c=+($("#tri_c").value||0)||null; var amt=sanitizeAmt(parseInt($("#tri_amt").value,10)); $("#tri_amt").value=amt; state.bets.tri=(a&&b&&c&&a!==b&&a!==c&&b!==c)?{type:"tri",a:a,b:b,c:c,amt:amt}:null; updateReady(); }
  if(kind==="win"){ $("#win_sel").oninput=saveWin; $("#win_amt").oninput=saveWin; saveWin(); }
  if(kind==="ex"){ $("#ex_a").oninput=saveEx; $("#ex_b").oninput=saveEx; $("#ex_amt").oninput=saveEx; saveEx(); }
  if(kind==="tri"){ ["tri_a","tri_b","tri_c"].forEach(function(id){ $("#"+id).oninput=saveTri; }); $("#tri_amt").oninput=saveTri; saveTri(); }
}
function updateReady(){ var ok=(state.bets.win&&state.bets.win.sel)||state.bets.ex||state.bets.tri; var b=$("#btnReady"); if(!b)return; if(ok) b.removeAttribute("disabled"); else b.setAttribute("disabled","disabled"); }

/* ========= スタート前演出 → レース ========= */
async function prepStart(){
  state.betsFinal=JSON.parse(JSON.stringify(state.bets));
  $("#stage").innerHTML=""; $("#race").style.display="block"; $("#race").setAttribute("aria-hidden","false");
  $("#lanes").innerHTML=""; $("#flag").textContent="距離：0%"; $("#specHUD").style.display="flex";

  var wrap=$("#lanesWrap");
  var TRACK=1000;
  var trackPx=Math.max(wrap.clientWidth*3, 5000);
  state.trackPx = trackPx; state.TRACK = TRACK;
  $("#lanes").style.width = trackPx + "px";

  // ミニマップCanvas取得＆リサイズ
  var mini=$("#miniCanvas"), mctx=mini.getContext("2d");
  function resizeMini(){
    var bb=document.getElementById("billboard");
    var w=bb.clientWidth-16; if(w<300) w=300;
    mini.width=w; mini.height=84;
  }
  resizeMini(); window.addEventListener("resize", resizeMini);

  // フィニッシュライン
  var finishX = trackPx - 96;
  var fl = el("div",{class:"finishLine",style:"left:"+finishX+"px"});
  var tag = el("div",{class:"finishTag",style:"left:"+finishX+"px"},"FINISH");
  $("#lanes").appendChild(fl); $("#lanes").appendChild(tag);

  // 10レーン
  CAST.forEach(function(c){
    var lane=el("div",{class:"lane"});
    var num = el("div",{class:"laneLabel"},"Lane "+c.id);
    var run = el("div",{class:"runner",id:"r"+c.id});
    var im  = el("img",{alt:c.name});
    var src=IMG.runner[c.id]||"", cached=PRELOADED[src];
    im.onerror=function(){this.style.display="none"}; im.src=(cached&&cached.src)?cached.src:src;
    run.appendChild(im); lane.appendChild(num); lane.appendChild(run);
    $("#lanes").appendChild(lane);
  });

  // 観戦HUD
  var follow=true; var userScrolling=false; var followChk=$("#followChk");
  followChk.checked=true; followChk.onchange=function(){ follow=this.checked; };
  wrap.addEventListener("scroll", function(){ userScrolling=true; clearTimeout(wrap._t); wrap._t=setTimeout(function(){ userScrolling=false; }, 200); });
  $("#jumpStart").onclick=function(){ wrap.scrollLeft = 0; };
  $("#jumpFinish").onclick=function(){ wrap.scrollLeft = wrap.scrollWidth - wrap.clientWidth; };

  // まもなく → カウントダウン
  var logo=el("div",{class:"centerLogo"}, el("img",{src:IMG.startLogo,alt:"start",onerror:"this.style.display='none'; this.parentElement.innerHTML='<div style=color:#fff;font-size:28px;font-weight:900>まもなくレース開始！</div>'"}));
  $("#race").appendChild(logo); await sleep(2000); safeRemove(logo);
  await startCountdown();

  async function startCountdown(){
    var cnt=$("#count"), seq=["3","2","1","GO"];
    for(var i=0;i<seq.length;i++){ cnt.textContent=seq[i]; cnt.style.opacity=1; await sleep(1000); cnt.style.opacity=0.2; await sleep(100); }
    cnt.textContent=""; await runRace();
  }

  // ミニマップ描画
  function drawMini(progressArr){ // [{id, prog(0..1), color}]
    var w=mini.width, h=mini.height, pad=8, lanes=10;
    mctx.clearRect(0,0,w,h);
    // 背景グリッド（レーン）
    for(var i=0;i<lanes;i++){
      var y = pad + i*((h-2*pad)/(lanes-1));
      mctx.strokeStyle = i%2? "#1f2937":"#243041";
      mctx.lineWidth = 10;
      mctx.beginPath(); mctx.moveTo(pad,y); mctx.lineTo(w-pad,y); mctx.stroke();
    }
    // フィニッシュ
    mctx.strokeStyle="#94a3b8"; mctx.lineWidth=2; 
    var fx = w - pad - 20; // 右端寄り
    mctx.beginPath(); mctx.moveTo(fx,pad-2); mctx.lineTo(fx,h-pad+2); mctx.stroke();

    // ランナー
    var r=5;
    progressArr.forEach(function(o,idx){
      var y = pad + (o.id-1)*((h-2*pad)/(lanes-1));
      var x = pad + (w-2*pad-20)*o.prog;
      mctx.fillStyle=o.color; 
      mctx.beginPath(); mctx.arc(x,y,r,0,Math.PI*2); mctx.fill();
      // 小さな白枠
      mctx.strokeStyle="#ffffffaa"; mctx.lineWidth=1;
      mctx.beginPath(); mctx.arc(x,y,r,0,Math.PI*2); mctx.stroke();
    });
  }

  // —— レース本体（ペース配分＋追い込み強化） ——
  async function runRace(){
    var offsetStart = 48; var goalPx = trackPx - 96;
    var duration = 15000 + Math.random()*5000;
    var avgTargetSpeed = TRACK / (duration/1000);

    var P={}, sumBase=0;
    (state.roster||CAST).forEach(function(r){
      var mood=(MOOD_VAL[r.mood]||1);
      var base=40*Math.pow(r.vmax/155,.5)*Math.pow(RANK_VAL[r.men]||1,.25)*Math.pow(RANK_VAL[r.tec]||1,.25)*mood;
      P[r.id]={x:0,v:base,vmax:base*1.4,men:RANK_VAL[r.men]||1,tec:RANK_VAL[r.tec]||1,kick:RANK_VAL[r.kick]||1,stab:RANK_VAL[r.stab]||1,color:r.color};
      sumBase+=base;
    });
    var avgBase=sumBase/CAST.length, globalScale=(TRACK/(duration/1000))/avgBase;

    // ペース配分関数（序盤ゆっくり→中盤普通→終盤ブースト）
    function phaseFactor(p){
      if(p<0.35){ var t=p/0.35; return lerp(0.65,0.85, easeInOutQuad(t)); }
      if(p<0.70){ var t=(p-0.35)/0.35; return lerp(0.90,1.00, easeInOutQuad(t)); }
      var t=(p-0.70)/0.30; return lerp(1.05,1.25, easeOutCubic(t));
    }

    var mid=false; var t0=performance.now();
    return new Promise(function(resolve){
      function step(t){
        var dt=Math.min(40,t-(step._last||t0)); step._last=t;
        var elapsed=t-t0, prog=Math.min(1,elapsed/duration);
        var anyMid=Object.keys(P).some(function(k){return P[k].x>=TRACK*0.5}); if(anyMid&&!mid) mid=true;

        // 進行
        Object.keys(P).forEach(function(id){
          var p=P[id];
          var jitter=(.985+.03*Math.random())*(1-(p.tec-1)*.10)*(1-(p.men-1)*.08);
          var global=globalScale * phaseFactor(prog);
          // トラブル（安定が高いほど軽減）
          var trouble=Math.random()<.015 ? (.86+.14*Math.random())*(1-(p.stab-1)*.25) : 1.0;
          // 追い込み：終盤でkickを効かせる（0→約 +20%程度まで）
          var late=clamp((prog-0.70)/0.30,0,1);
          var kickBoost = 1 + (p.kick-1) * easeOutCubic(late) * 0.9;

          var vTarget = p.v * jitter * global * trouble * kickBoost;
          p.v += (vTarget - p.v) * 0.045;
          p.v = Math.max(10, Math.min(p.v, p.vmax*globalScale*1.20)); // 上限少し上げる
          p.x += p.v * (dt/1000);
          if(p.x>TRACK) p.x=TRACK;

          var px = (p.x/TRACK) * goalPx;
          $("#r"+id).style.left = (offsetStart+px) + "px";
        });

        // 進捗・追尾
        var leadX = Math.max.apply(null, Object.keys(P).map(function(k){return P[k].x;}));
        $("#flag").textContent="距離："+Math.round(leadX/TRACK*100)+"%";

        // ミニマップ更新
        var progressArr = Object.keys(P).map(function(id){
          return {id:+id, prog:P[id].x/TRACK, color:P[id].color};
        });
        drawMini(progressArr);

        if(follow && !userScrolling){
          var leadPx = (leadX/TRACK)*goalPx + offsetStart;
          var targetLeft = Math.max(0, leadPx - wrap.clientWidth*0.45);
          wrap.scrollLeft += (targetLeft - wrap.scrollLeft)*0.18;
        }

        var done = Object.keys(P).every(function(k){return P[k].x>=TRACK-0.1});
        if(done){ resolve(finish()); return; }
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    });

    function finish(){
      var order = Object.keys(P).map(function(id){return{id:+id,x:P[id].x+Math.random()*0.001}})
        .sort(function(a,b){return b.x-a.x}).map(function(o){return o.id});
      state.finish=order; showResult();
    }
  }
}

/* ========= ベット清算・結果 ========= */
function settleBets(order){
  var total=0, b=state.betsFinal||{}, msgs=[];
  if(b.win){ var ok=(order[0]===b.win.sel); if(ok){ var odd=state.odds.win[b.win.sel]; var gain=Math.floor(b.win.amt*odd); total+=gain; msgs.push("単勝 的中 +"+gain);} else msgs.push("単勝 ハズレ"); }
  if(b.ex){ var ok2=(order[0]===b.ex.a && order[1]===b.ex.b); if(ok2){ var key=b.ex.a+"-"+b.ex.b; var odd2=state.odds.ex[key]||0; var gain2=Math.floor(b.ex.amt*odd2); total+=gain2; msgs.push("2連 的中 +"+gain2);} else msgs.push("2連 ハズレ"); }
  if(b.tri){ var ok3=(order[0]===b.tri.a && order[1]===b.tri.b && order[2]===b.tri.c); if(ok3){ var key3=b.tri.a+"-"+b.tri.b+"-"+b.tri.c; var odd3=state.odds.tri[key3]||0; var gain3=Math.floor(b.tri.amt*odd3); total+=gain3; msgs.push("3連 的中 +"+gain3);} else msgs.push("3連 ハズレ"); }
  return {payout:total, hitText: total>0?("的中！ "+total+" コイン手に入れた！"):("残念！ハズレ！　("+msgs.join(" / ")+")")};
}
function showResult(){
  var order=state.finish;
  var list = order.map(function(id,i){
    var c=CAST.find(function(x){return x.id===id});
    return '<div style="display:flex;align-items:center;gap:10px"><span>'+(i+1)+'位</span><img class="chipImg" src="'+(IMG.runner[c.id]||"")+'" alt="'+c.name+'" onerror="this.style.display=\'none\'"><span>'+c.id+'. '+c.name+'</span></div>';
  }).join("");
  var st = settleBets(order);
  $("#race").style.display="none"; $("#race").setAttribute("aria-hidden","true");
  $("#stage").innerHTML =
    '<div class="panel" style="width:min(720px,92vw)"><header><h1>順位発表</h1></header><div class="pbody">'+
    '<div class="resultList">'+list+'</div>'+
    '<div class="pay '+(st.payout>0?'good':'bad')+'">'+st.hitText+'</div>'+
    '<div style="font-size:12px; color:#9fb0c9; margin-top:6px">※ 2秒後に「次のレースに進みますか？」が表示されます。</div>'+
    '</div></div>';
  setTimeout(askNext,2000);
}
function askNext(){
  $("#stage").innerHTML =
    '<div class="panel paperWrap" style="width:min(520px,92vw)">'+
    '<header><h1>次のレースに進みますか？</h1></header>'+
    '<div class="pbody"><div class="grid two">'+
    '<button class="btnPrimary" id="yes">はい</button>'+
    '<button class="btnGhost" id="no">いいえ</button>'+
    '</div><div style="font-size:12px; color:#9fb0c9; margin-top:10px">※「はい」で再び選手紹介からスタートします。</div></div></div>';
  $("#yes").onclick=function(){ showIntroLogoThenIntro(); };
  $("#no").onclick=function(){ $("#stage").innerHTML='<div class="panel"><header><h1>終了</h1></header><div class="pbody">ご利用ありがとうございました。</div></div>'; };
}

/* ========= 便利 ========= */
$("#btnReset").onclick=function(){ location.reload(); };
</script>
</body>
</html>
